<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Space Project</title>
  <link rel="icon" href="icon.ico" type="image/x-icon" />
  <style>
    body {
      margin: 0;
      height: 100vh;
      background-image: url('fondo.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      font-family: Arial, sans-serif;
      text-align: center;
      color: white;
      text-shadow: 2px 2px 5px black;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: background-image 1s ease-in-out;
      position: relative;
      overflow: hidden;
    }

    #backgroundFade {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('mount-fuji-2305606_1280.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0;
      pointer-events: none;
      animation-fill-mode: forwards;
      z-index: -1;
    }

    @keyframes fadeBackground {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    #contador {
      font-size: 80px;
      user-select: none;
      z-index: 10;
    }

    #emojiSonido {
      font-size: 50px;
      margin-bottom: 10px;
      user-select: none;
      z-index: 10;
    }

    p {
      font-size: 24px;
      margin: 0 0 20px 0;
      user-select: none;
      z-index: 10;
    }

    /* Botones estilo */
    #muteBtn, #soundBtn, #changeMusicBtn {
      position: absolute;
      width: 40px;
      height: 40px;
      cursor: pointer;
      opacity: 0.8;
      user-select: none;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 28px;
      background: rgba(0,0,0,0.3);
      border-radius: 6px;
      transition: background 0.3s;
      z-index: 10;
    }
    #muteBtn:hover, #soundBtn:hover, #changeMusicBtn:hover {
      background: rgba(255,255,255,0.2);
    }

    #muteBtn {
      top: 10px;
      left: 10px;
    }

    #soundBtn {
      top: 60px;
      left: 10px;
      font-size: 32px;
      line-height: 1;
    }

    #changeMusicBtn {
      top: 10px;
      left: 60px;
    }

    /* Menú selector sonidos */
    #soundMenu {
      position: absolute;
      top: 110px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      padding: 5px;
      border-radius: 5px;
      display: none;
      user-select: none;
      z-index: 10;
    }

    .soundOption {
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
    }

    .soundOption.selected {
      background: rgba(255,255,255,0.3);
      border-radius: 4px;
    }

    /* Nuevo menú música */
    #musicMenu {
      position: absolute;
      top: 60px;
      left: 60px;
      background: rgba(0,0,0,0.7);
      border-radius: 6px;
      padding: 8px 12px;
      display: none;
      user-select: none;
      min-width: 160px;
      box-shadow: 0 0 10px rgba(0,0,0,0.8);
      animation: fadeUp 0.3s ease forwards;
      z-index: 100;
    }

    .musicOption {
      font-size: 20px;
      padding: 8px 10px;
      cursor: pointer;
      border-radius: 4px;
      color: white;
      opacity: 0;
      transform: translateY(15px);
      animation-fill-mode: forwards;
      animation-timing-function: ease-out;
    }

    .musicOption:hover {
      background: rgba(255,255,255,0.2);
    }

    /* Animación fade + subir */
    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Barra de volumen vertical a la derecha */
    #volumeControl {
      position: fixed;
      top: 50%;
      right: 5px;
      transform: translateY(-50%) rotate(-90deg);
      width: 140px;
      height: 30px;
      opacity: 0.7;
      cursor: pointer;
      z-index: 150;
      -webkit-appearance: none;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      outline: none;
    }

    /* Estilos para thumb con imagen */
    #volumeControl::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 30px;
      height: 30px;
      background: transparent;
      cursor: pointer;
      border: none;
      margin-top: -9px; /* centrar verticalmente */
      background-image: url('wave-1837426_1280.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      transition: transform 0.2s ease;
    }
    #volumeControl::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    #volumeControl::-moz-range-thumb {
      width: 30px;
      height: 30px;
      background: transparent;
      cursor: pointer;
      border: none;
      background-image: url('wave-1837426_1280.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      transition: transform 0.2s ease;
    }
    #volumeControl::-moz-range-thumb:hover {
      transform: scale(1.2);
    }

    /* Estilos enemigo */
    #enemyContainer {
      position: fixed;
      bottom: -300px;
      left: 50%;
      transform: translateX(-50%);
      width: 200px;
      height: 250px;
      background-image: url('el momo.png');
      background-size: contain;
      background-repeat: no-repeat;
      transition: bottom 2s ease;
      z-index: 120;
      pointer-events: none;
    }

    /* Imagen objeción */
    #objecionImg {
      position: fixed;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 300px;
      height: auto;
      display: none;
      z-index: 130;
      pointer-events: none;
      user-select: none;
    }
  </style>
</head>
<body>
  <!-- Fondo para fade -->
  <div id="backgroundFade"></div>

  <!-- Botón silenciar -->
  <img id="muteBtn" src="nosound.png" alt="Silenciar" title="Silenciar música" />

  <!-- Botón selector de sonido -->
  <div id="soundBtn" title="Cambiar sonido">🎹</div>

  <!-- Botón cambio canción -->
  <div id="changeMusicBtn" title="Cambiar canción de fondo">🎵</div>

  <!-- Menú selector sonidos -->
  <div id="soundMenu">
    <div class="soundOption selected" data-sound="normal">🔊</div>
    <div class="soundOption" data-sound="piano">🎹</div>
  </div>

  <!-- Menú cambio música -->
  <div id="musicMenu">
    <div class="musicOption" data-music="CHIHIRO">CHIHIRO LOFI</div>
    <div class="musicOption" data-music="CRYSTAL">Crystal Ambient</div>
  </div>

  <!-- Barra volumen -->
  <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="1" title="Volumen música" />

  <p>Presiona la tecla <strong>Espacio</strong> o toca la pantalla:</p>
  <div id="emojiSonido">🔊</div>
  <div id="contador">0</div>

  <!-- Enemigo y objeción -->
  <div id="enemyContainer"></div>
  <img id="objecionImg" src="objecion.png" alt="Objeción" />

  <!-- Audios -->
  <!-- CHIHIRO LOFI -->
  <audio id="musica" src="CHIHIRO_BUT_ITS_LOFI_RE_CHILL_DEA.mp3" loop></audio>

  <!-- Crystal Ambient -->
  <audio id="musicaAlterna" src="crystal-ambient-piano-252638.mp3" loop></audio>

  <audio id="sonido" src="sonido.mp3"></audio>
  <audio id="sonido100" src="100.mp3"></audio>
  <audio id="sonidoMi" src="mi-80239.mp3"></audio>

  <!-- Audios evento enemigo -->
  <audio id="audioMinecraft" src="Minecraft.mp3"></audio>
  <audio id="audioMalardo" src="malardo.mp3"></audio>

<script>
  let contador = 0;

  // Música y estado
  let musicaFondo = document.getElementById("musica");
  let musicaAlterna = document.getElementById("musicaAlterna");
  let musicaActual = musicaFondo;
  let musicaIniciada = false;

  // Controles UI
  let contadorElemento = document.getElementById("contador");
  let emojiSonido = document.getElementById("emojiSonido");
  let sonidoEspacio = document.getElementById("sonido");
  let sonido100 = document.getElementById("sonido100");
  let sonidoMi = document.getElementById("sonidoMi");
  let muteBtn = document.getElementById("muteBtn");
  let soundBtn = document.getElementById("soundBtn");
  let soundMenu = document.getElementById("soundMenu");
  let changeMusicBtn = document.getElementById("changeMusicBtn");
  let musicMenu = document.getElementById("musicMenu");
  let volumeControl = document.getElementById("volumeControl");

  let currentSound = "normal"; // "normal" o "piano"

  // Pitch progresivo piano
  let pianoPitch = 1.0; 
  let pianoPitchStep = 0.05; 
  let pianoPitchMax = 2.0; 

  // Audios evento enemigo
  let audioMinecraft = document.getElementById("audioMinecraft");
  let audioMalardo = document.getElementById("audioMalardo");

  // FadeOut y FadeIn para música
  function fadeOut(audio, callback) {
    let fadeInterval = setInterval(() => {
      if (audio.volume > 0.05) {
        audio.volume = Math.max(0, audio.volume - 0.05);
      } else {
        clearInterval(fadeInterval);
        audio.volume = 0;
        audio.pause();
        if (callback) callback();
      }
    }, 100);
  }

  function fadeIn(audio) {
    audio.volume = 0;
    audio.play();
    let fadeInterval = setInterval(() => {
      if (audio.volume < volumeControl.value - 0.05) {
        audio.volume = Math.min(volumeControl.value, audio.volume + 0.05);
      } else {
        audio.volume = volumeControl.value;
        clearInterval(fadeInterval);
      }
    }, 100);
  }

  // Cambiar fondo al llegar a 150 y 250
  function cambiarFondo() {
    if (contador === 150) {
      document.body.style.backgroundImage = "url('fondo2.jpg')";
    } else if (contador === 250) {
      let bgFade = document.getElementById('backgroundFade');
      bgFade.style.opacity = '0';
      bgFade.style.animation = 'fadeBackground 2s ease forwards';
    }
  }

  // Iniciar música activa
  function startMusic() {
    if (!musicaIniciada) {
      musicaActual.volume = volumeControl.value;
      musicaActual.play();
      let fadeInterval = setInterval(() => {
        if (musicaActual.volume < volumeControl.value - 0.05) {
          musicaActual.volume = Math.min(volumeControl.value, musicaActual.volume + 0.05);
        } else {
          musicaActual.volume = volumeControl.value;
          clearInterval(fadeInterval);
        }
      }, 100);
      musicaIniciada = true;
    }
  }

  // Cambiar canción con fade
  function cambiarCancion(nuevaMusica) {
    if (musicaActual === nuevaMusica) return;

    fadeOut(musicaActual, () => {
      nuevaMusica.volume = 0;
      nuevaMusica.play();
      let fadeInInterval = setInterval(() => {
        if (nuevaMusica.volume < volumeControl.value - 0.05) {
          nuevaMusica.volume = Math.min(volumeControl.value, nuevaMusica.volume + 0.05);
        } else {
          nuevaMusica.volume = volumeControl.value;
          clearInterval(fadeInInterval);
        }
      }, 100);
      musicaActual = nuevaMusica;
    });
  }

  // Variables para enemigo y objeción
  let enemyContainer = document.getElementById('enemyContainer');
  let objecionImg = document.getElementById('objecionImg');

  let contadorParado = false;
  let objecionActiva = false;
  let objecionStartTime;

  // Variables evento disparo enemigo
  let disparoEsperadoInicio = 7035; // ms desde que empezó audio (7.035 s)
  let disparoEsperadoFin = 8035;    // ms (8.035 s)
  let disparoExitoso = false;
  let disparoTimeout;

  // Acción principal al presionar espacio o tocar
  function updateCounter() {
    if (contadorParado) return; // Detener contador mientras parado

    contador++;
    contadorElemento.textContent = contador;
    cambiarFondo();

    if (contador === 300) {
      iniciarEncuentroEnemigo();
      return;
    }

    if (currentSound === "normal") {
      sonidoEspacio.currentTime = 0;
      sonidoEspacio.play();
    } else if (currentSound === "piano") {
      sonidoMi.currentTime = 0;
      sonidoMi.playbackRate = pianoPitch;
      sonidoMi.volume = 0.9;
      sonidoMi.play();

      pianoPitch += pianoPitchStep;
      if (pianoPitch > pianoPitchMax) {
        pianoPitch = 1.0;
      }
    }

    if (contador % 100 === 0) {
      if (currentSound === "normal") sonidoEspacio.pause();
      if (currentSound === "piano") sonidoMi.pause();
      sonido100.currentTime = 0;
      sonido100.play();
    }
  }

  // Iniciar encuentro enemigo
  function iniciarEncuentroEnemigo() {
    contadorParado = true;
    disparoExitoso = false;

    // Mostrar enemigo con animación subida
    enemyContainer.style.transition = "bottom 2s ease";
    enemyContainer.style.bottom = '20px';

    // Reproducir audio Minecraft
    audioMinecraft.currentTime = 0;
    audioMinecraft.volume = 1;
    audioMinecraft.play();

    // Mostrar objecion después de 5 segundos de subida enemigo
    setTimeout(() => {
      mostrarObjecion();
    }, 5000);

    // Timeout para fallo si no disparas en la ventana correcta
    disparoTimeout = setTimeout(() => {
      if (!disparoExitoso) {
        objecionActiva = false;
        objecionImg.style.display = 'none';
        contadorParado = false; // Permitir seguir jugando si falla
      }
    }, disparoEsperadoFin + 500); // Esperar hasta un poco después del fin

    // Reset objecion en caso que audio acabe antes
    audioMinecraft.onended = () => {
      if (!disparoExitoso) {
        objecionActiva = false;
        objecionImg.style.display = 'none';
        contadorParado = false;
      }
    };
  }

  // Mostrar objecion y activar ventana para disparo
  function mostrarObjecion() {
    objecionActiva = true;
    objecionStartTime = Date.now();
    objecionImg.style.display = 'block';
  }

  // Animación caída enemigo y audio malardo
  function animacionCaidaEnemigo() {
    enemyContainer.style.transition = "bottom 1s ease";
    enemyContainer.style.bottom = "-300px";

    audioMalardo.currentTime = 0;
    audioMalardo.play();

    // Al terminar animación, reactivar contador
    setTimeout(() => {
      enemyContainer.style.transition = "";
      contadorParado = false;
    }, 1000);
  }

  // Detectar si es dispositivo táctil
  const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

  // Evento tecla espacio para PC y teclado
  document.addEventListener("keyup", (e) => {
    if (e.code === "Space") {
      if (!musicaIniciada) startMusic();

      if (objecionActiva) {
        let tiempoActualAudio = audioMinecraft.currentTime * 1000; // ms

        if (tiempoActualAudio >= disparoEsperadoInicio && tiempoActualAudio <= disparoEsperadoFin) {
          disparoExitoso = true;
          objecionActiva = false;
          objecionImg.style.display = 'none';
          clearTimeout(disparoTimeout);

          // Sumar 100 puntos por eliminar enemigo
          contador += 100;
          contadorElemento.textContent = contador;

          animacionCaidaEnemigo();

          audioMinecraft.pause();

          cambiarCancion(musicaAlterna);
          musicaIniciada = true;
        }
      } else {
        updateCounter();
      }
    }
  });

  // Evento click solo si es dispositivo táctil (móvil/tablet)
  if (isTouchDevice) {
    document.addEventListener("click", () => {
      if (!musicaIniciada) startMusic();

      if (objecionActiva) {
        let tiempoActualAudio = audioMinecraft.currentTime * 1000; // ms

        if (tiempoActualAudio >= disparoEsperadoInicio && tiempoActualAudio <= disparoEsperadoFin) {
          disparoExitoso = true;
          objecionActiva = false;
          objecionImg.style.display = 'none';
          clearTimeout(disparoTimeout);

          // Sumar 100 puntos por eliminar enemigo
          contador += 100;
          contadorElemento.textContent = contador;

          animacionCaidaEnemigo();

          audioMinecraft.pause();

          cambiarCancion(musicaAlterna);
          musicaIniciada = true;
        }
      } else {
        updateCounter();
      }
    });
  }

  // Botón mute toggle
  muteBtn.addEventListener('click', () => {
    if (musicaActual.volume > 0) {
      musicaActual.volume = 0;
      muteBtn.src = 'sound.png';
      emojiSonido.textContent = '🔈';
    } else {
      musicaActual.volume = volumeControl.value;
      muteBtn.src = 'nosound.png';
      emojiSonido.textContent = '🔊';
    }
  });

  // Mostrar u ocultar menú selector sonido
  soundBtn.addEventListener('click', () => {
    if (soundMenu.style.display === 'block') {
      soundMenu.style.display = 'none';
    } else {
      soundMenu.style.display = 'block';
      musicMenu.style.display = 'none'; // Cerrar menú música si está abierto
    }
  });

  // Elegir sonido normal o piano
  soundMenu.querySelectorAll('.soundOption').forEach(option => {
    option.addEventListener('click', () => {
      currentSound = option.getAttribute('data-sound');
      soundMenu.querySelectorAll('.soundOption').forEach(opt => opt.classList.remove('selected'));
      option.classList.add('selected');
      soundMenu.style.display = 'none';
    });
  });

  // Mostrar u ocultar menú música
  changeMusicBtn.addEventListener('click', () => {
    if (musicMenu.style.display === 'block') {
      musicMenu.style.display = 'none';
    } else {
      musicMenu.style.display = 'block';
      soundMenu.style.display = 'none'; // Cerrar menú sonido si está abierto
    }
  });

  // Selección de música
  musicMenu.querySelectorAll('.musicOption').forEach(option => {
    option.addEventListener('click', () => {
      let selectedMusic = option.getAttribute('data-music');
      if (selectedMusic === "CHIHIRO") {
        cambiarCancion(musicaFondo);
      } else if (selectedMusic === "CRYSTAL") {
        cambiarCancion(musicaAlterna);
      }
      musicMenu.style.display = 'none';
    });
  });

  // Control volumen
  volumeControl.addEventListener('input', () => {
    musicaActual.volume = volumeControl.value;
  });

  // Para evitar que toque accidental cierre menú
  document.body.addEventListener('click', (e) => {
    if (!soundBtn.contains(e.target) && !soundMenu.contains(e.target)) {
      soundMenu.style.display = 'none';
    }
    if (!changeMusicBtn.contains(e.target) && !musicMenu.contains(e.target)) {
      musicMenu.style.display = 'none';
    }
  });
</script>
</body>
</html>
